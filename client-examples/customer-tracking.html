<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚´ ì£¼ë¬¸ ì‹¤ì‹œê°„ ì¶”ì </title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        input, button {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            background: #007bff;
            color: white;
            cursor: pointer;
            border: none;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            align-items: center;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #dc3545;
        }

        .status-dot.connected {
            background: #28a745;
        }

        .delivery-status {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .status-badge.pending {
            background: #ffc107;
            color: #000;
        }

        .status-badge.in-transit {
            background: #007bff;
            color: white;
        }

        .status-badge.delivered {
            background: #28a745;
            color: white;
        }

        .map-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        #map {
            width: 100%;
            height: 400px;
            background: #e0e0e0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }

        .info-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-card {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            text-align: center;
        }

        .info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .log {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        .log-entry {
            padding: 5px;
            border-bottom: 1px solid #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš ë‚´ ì£¼ë¬¸ ì‹¤ì‹œê°„ ì¶”ì </h1>
            <div class="controls">
                <input type="number" id="orderIdInput" placeholder="ì£¼ë¬¸ ID ì…ë ¥ (ì˜ˆ: 1)" value="">
                <button id="connectBtn" onclick="connectWebSocket()">ì¶”ì  ì‹œì‘</button>
                <button id="disconnectBtn" onclick="disconnectWebSocket()" disabled>ì¶”ì  ì¤‘ì§€</button>
            </div>
            <div class="status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">ì¶”ì  ì•ˆí•¨</span>
                <span>|</span>
                <span>ì£¼ë¬¸ ID: <strong id="currentOrderId">-</strong></span>
            </div>
        </div>

        <div class="delivery-status">
            <h2>ë°°ì†¡ ìƒíƒœ</h2>
            <div style="margin-top: 10px;">
                <span class="status-badge pending" id="deliveryStatusBadge">ëŒ€ê¸° ì¤‘</span>
                <p style="margin-top: 10px; color: #666;" id="deliveryStatusMessage">
                    ë°°ì†¡ì´ ì‹œì‘ë˜ë©´ ë“œë¡ ì˜ ì‹¤ì‹œê°„ ìœ„ì¹˜ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </div>
        </div>

        <div class="map-container">
            <h2>ë“œë¡  ìœ„ì¹˜</h2>
            <div id="map">
                <div style="text-align: center;">
                    <p style="font-size: 18px; margin-bottom: 10px;">ì—¬ê¸°ì— ì§€ë„ APIë¥¼ í†µí•©í•˜ì„¸ìš”</p>
                    <p style="font-size: 14px;">Google Maps, Kakao Maps, Naver Maps ë“±</p>
                    <p style="font-size: 14px; margin-top: 20px;">í˜„ì¬ëŠ” ì•„ë˜ ì •ë³´ì—ì„œ ìœ„ì¹˜ ë°ì´í„°ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                </div>
            </div>
        </div>

        <div class="info-panel">
            <h2>ë“œë¡  ì •ë³´</h2>
            <div class="info-grid">
                <div class="info-card">
                    <div class="info-label">ìœ„ë„</div>
                    <div class="info-value" id="latValue">-</div>
                </div>
                <div class="info-card">
                    <div class="info-label">ê²½ë„</div>
                    <div class="info-value" id="lngValue">-</div>
                </div>
                <div class="info-card">
                    <div class="info-label">ì†ë„</div>
                    <div class="info-value" id="speedValue">-</div>
                </div>
                <div class="info-card">
                    <div class="info-label">ë°°í„°ë¦¬</div>
                    <div class="info-value" id="batteryValue">-</div>
                </div>
            </div>

            <h3 style="margin-top: 20px;">ìœ„ì¹˜ ì—…ë°ì´íŠ¸ ë¡œê·¸</h3>
            <div class="log" id="logPanel">
                <div class="log-entry">
                    <span style="color: #666;">ì‹œì‘</span>
                    <span> - ì£¼ë¬¸ IDë¥¼ ì…ë ¥í•˜ê³  ì¶”ì ì„ ì‹œì‘í•˜ì„¸ìš”</span>
                </div>
            </div>
        </div>
    </div>

    <!-- SockJSì™€ STOMP ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <script>
        let stompClient = null;
        let positionSubscription = null;
        let statusSubscription = null;
        const WS_URL = 'http://localhost:8080/ws';

        // WebSocket ì—°ê²°
        function connectWebSocket() {
            const orderId = document.getElementById('orderIdInput').value;
            if (!orderId) {
                alert('ì£¼ë¬¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            if (stompClient && stompClient.connected) {
                alert('ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤');
                return;
            }

            addLog('WebSocket ì—°ê²° ì‹œë„ ì¤‘...');

            const socket = new SockJS(WS_URL);
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function(frame) {
                addLog('WebSocket ì—°ê²° ì„±ê³µ!');
                updateConnectionStatus(true);
                document.getElementById('currentOrderId').textContent = orderId;

                // ë“œë¡  ìœ„ì¹˜ êµ¬ë…
                positionSubscription = stompClient.subscribe('/topic/order/' + orderId + '/position', function(message) {
                    const data = JSON.parse(message.body);
                    handleDronePosition(data);
                });

                // ë°°ì†¡ ì™„ë£Œ ì•Œë¦¼ êµ¬ë… (ê¸°ì¡´ì— ìˆë˜ ê²ƒ)
                statusSubscription = stompClient.subscribe('/topic/order/' + orderId, function(message) {
                    const data = JSON.parse(message.body);
                    handleDeliveryStatus(data);
                });

                addLog(`ì£¼ë¬¸ ${orderId} ì¶”ì  ì‹œì‘`);

            }, function(error) {
                addLog('WebSocket ì—°ê²° ì‹¤íŒ¨: ' + error);
                updateConnectionStatus(false);
            });
        }

        // WebSocket ì—°ê²° í•´ì œ
        function disconnectWebSocket() {
            if (stompClient && stompClient.connected) {
                if (positionSubscription) positionSubscription.unsubscribe();
                if (statusSubscription) statusSubscription.unsubscribe();

                stompClient.disconnect(function() {
                    addLog('WebSocket ì—°ê²° í•´ì œë¨');
                    updateConnectionStatus(false);
                    document.getElementById('currentOrderId').textContent = '-';
                });
            }
        }

        // ë“œë¡  ìœ„ì¹˜ ë°ì´í„° ì²˜ë¦¬
        function handleDronePosition(data) {
            console.log('ë“œë¡  ìœ„ì¹˜ ì—…ë°ì´íŠ¸:', data);

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('latValue').textContent = data.lat.toFixed(6);
            document.getElementById('lngValue').textContent = data.lng.toFixed(6);
            document.getElementById('speedValue').textContent = data.speed.toFixed(1) + ' km/h';
            document.getElementById('batteryValue').textContent = data.battery.toFixed(1) + '%';

            // ë°°ì†¡ ìƒíƒœ ì—…ë°ì´íŠ¸
            const badge = document.getElementById('deliveryStatusBadge');
            const message = document.getElementById('deliveryStatusMessage');

            if (data.status === 'IN_TRANSIT') {
                badge.className = 'status-badge in-transit';
                badge.textContent = 'ë°°ì†¡ ì¤‘';
                message.textContent = 'ë“œë¡ ì´ íšŒì›ë‹˜ì˜ ì§‘ìœ¼ë¡œ í–¥í•˜ê³  ìˆìŠµë‹ˆë‹¤!';
            }

            // ë¡œê·¸ ì¶”ê°€
            addLog(`ìœ„ì¹˜ ì—…ë°ì´íŠ¸: (${data.lat.toFixed(6)}, ${data.lng.toFixed(6)}) | ë°°í„°ë¦¬: ${data.battery.toFixed(1)}%`);

            // ì‹¤ì œ ì§€ë„ API ì‚¬ìš© ì‹œ ë§ˆì»¤ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            updateMapMarker(data.lat, data.lng);
        }

        // ë°°ì†¡ ìƒíƒœ ë³€ê²½ ì²˜ë¦¬ (ì™„ë£Œ ë“±)
        function handleDeliveryStatus(data) {
            console.log('ë°°ì†¡ ìƒíƒœ ë³€ê²½:', data);

            if (data.status === 'FULFILLED') {
                const badge = document.getElementById('deliveryStatusBadge');
                const message = document.getElementById('deliveryStatusMessage');

                badge.className = 'status-badge delivered';
                badge.textContent = 'ë°°ì†¡ ì™„ë£Œ';
                message.textContent = 'ë°°ì†¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰';

                addLog('âœ… ë°°ì†¡ ì™„ë£Œ!');

                // 5ì´ˆ í›„ ìë™ìœ¼ë¡œ ì—°ê²° í•´ì œ
                setTimeout(() => {
                    disconnectWebSocket();
                }, 5000);
            }
        }

        // ì§€ë„ ë§ˆì»¤ ì—…ë°ì´íŠ¸ (ì˜ˆì‹œ)
        function updateMapMarker(lat, lng) {
            console.log('ì§€ë„ ë§ˆì»¤ ìœ„ì¹˜ ì—…ë°ì´íŠ¸:', lat, lng);
            // ì‹¤ì œ ì§€ë„ API êµ¬í˜„
        }

        // ì—°ê²° ìƒíƒœ UI ì—…ë°ì´íŠ¸
        function updateConnectionStatus(connected) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');

            if (connected) {
                statusDot.className = 'status-dot connected';
                statusText.textContent = 'ì¶”ì  ì¤‘';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                statusDot.className = 'status-dot';
                statusText.textContent = 'ì¶”ì  ì•ˆí•¨';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        // ë¡œê·¸ ì¶”ê°€
        function addLog(message) {
            const logPanel = document.getElementById('logPanel');
            const time = new Date().toLocaleTimeString('ko-KR');

            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span style="color: #666;">${time}</span> - <span>${message}</span>`;

            logPanel.insertBefore(logEntry, logPanel.firstChild);

            while (logPanel.children.length > 50) {
                logPanel.removeChild(logPanel.lastChild);
            }
        }

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì—°ê²° í•´ì œ
        window.addEventListener('beforeunload', function() {
            if (stompClient && stompClient.connected) {
                stompClient.disconnect();
            }
        });
    </script>
</body>
</html>
